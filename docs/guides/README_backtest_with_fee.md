# Pine Script 对齐版回测函数 - 使用说明

## 文件说明

### 1. `backtest_with_fee.R` - 主回测函数库
包含完整的回测引擎，核心特性：

**盘中触发逻辑**
- 使用 `High` 价格判断止盈触发（而非 `Close` 价）
- 使用 `Low` 价格判断止损触发（而非 `Close` 价）
- 同时触发时，根据K线形态判断优先级：
  - 阳线（Close >= Open）：先止盈
  - 阴线（Close < Open）：先止损

**手续费模型**
- 单边手续费：0.075%（可配置）
- 双边总成本：0.15%
- 入场时扣除：`entry_capital = capital * (1 - 0.00075)`
- 出场时扣除：`exit_capital = position * exit_price * (1 - 0.00075)`

**自动化功能**
- 自动检测时间框架（支持xts对象和data.table）
- 自动转换回看天数为K线数量
- 详细的交易日志输出
- 完整的统计指标

### 2. `test_with_fee.R` - 版本对比测试脚本
对比三种回测版本的性能差异：

- **版本A**：无手续费 + 收盘价触发（旧版逻辑）
- **版本B**：无手续费 + 盘中触发（改进版）
- **版本C**：0.075%手续费 + 盘中触发（最终版，对齐Pine Script）

## 使用示例

### 基本用法

```r
library(data.table)
library(lubridate)

# 加载回测函数
source("backtest_with_fee.R")

# 加载数据
load("liaochu.RData")
data <- cryptodata[["PEPEUSDT_15m"]]

# 转换xts为data.table
if (inherits(data, "xts")) {
  require(xts)
  timestamps <- index(data)
  data <- as.data.table(data)
  data[, timestamp := timestamps]
  setnames(data, tolower(names(data)))
}

# 运行回测
result <- run_backtest(
  data = data,
  lookback_days = 3,      # 回看3天
  drop_threshold = 0.20,  # 跌幅20%触发
  initial_capital = 1000, # 初始资金$1000
  take_profit = 0.10,     # 止盈10%
  stop_loss = 0.10,       # 止损10%
  fee_rate = 0.00075      # 单边手续费0.075%
)

# 查看结果
print(result$stats)
View(result$trades)
```

### 运行对比测试

```r
# 直接运行测试脚本
source("test_with_fee.R")

# 结果已保存在 results 变量中
print(results$comparison)
```

## 测试结果（PEPEUSDT_15m 数据）

### 参数设置
- 回看天数：3天
- 跌幅阈值：20%
- 初始资金：$1,000
- 止盈/止损：10%
- 手续费：0.075%（单边）

### 性能对比

| 版本 | 总交易 | 胜率 | 最终资金 | 总收益率 | 总手续费 |
|------|--------|------|----------|----------|----------|
| A: 无费用+收盘触发 | 127 | 58.27% | $3,952.36 | 295.24% | $0.00 |
| B: 无费用+盘中触发 | 153 | 58.82% | $6,960.17 | 596.02% | $0.00 |
| C: 0.075%费+盘中触发 | 153 | 58.82% | $5,532.38 | 453.24% | $684.51 |

### 关键发现

**1. 盘中触发的影响（A vs B）**
- 盈亏提升：+$3,007.80 (+300.78%)
- 交易次数增加：127 → 153（+20.5%）
- **结论**：盘中触发能更及时地执行止盈/止损，显著提高收益

**2. 手续费的影响（B vs C）**
- 盈亏下降：-$1,427.79 (-142.78%)
- 总手续费：$684.51（占初始资金68.45%）
- 手续费占总盈亏：11.48%
- **结论**：手续费对高频策略影响显著，但仍保持可观收益

**3. 综合影响（A vs C）**
- 最终提升：+$1,580.01 (+158.00%)
- **结论**：即使考虑手续费，改进版回测仍显著优于旧版

### 前5笔交易对比

```
交易 #1:
  [A] 出场: 2023-05-09 03:29:59 @ $0.000002, 盈亏: $109.09 (10.91%), TP
  [B] 出场: 2023-05-09 03:29:59 @ $0.000002, 盈亏: $100.00 (10.00%), TP
  [C] 出场: 2023-05-09 03:29:59 @ $0.000002, 盈亏: $98.35 (9.84%), TP, 费: $1.65

交易 #2:
  [A] 出场: 2023-05-09 05:44:59 @ $0.000002, 盈亏: $156.65 (14.12%), TP
  [B] 出场: 2023-05-09 05:44:59 @ $0.000002, 盈亏: $110.00 (10.00%), TP
  [C] 出场: 2023-05-09 05:44:59 @ $0.000002, 盈亏: $108.02 (9.84%), TP, 费: $1.81
```

**观察**：
- 版本A（收盘触发）可能超过止盈目标（如14.12%），也可能超过止损（如-10.40%）
- 版本B/C（盘中触发）精确控制在10%止盈/止损附近
- 版本C在版本B基础上扣除手续费，实际盈亏约为9.84%/-10.13%

## 核心函数说明

### `detect_timeframe(data)`
自动检测数据的时间框架（分钟数）

### `convert_days_to_bars(lookback_days, timeframe_minutes)`
将回看天数转换为K线数量

### `generate_signals(data, lookback_bars, drop_threshold)`
生成交易信号（使用High/Low判断跌幅）

### `backtest_with_intrabar_and_fee(data, initial_capital, take_profit, stop_loss, fee_rate)`
核心回测引擎，包含盘中触发和手续费

### `run_backtest(...)`
完整的回测流程（主函数）

## 与Pine Script的对齐

该实现完全对齐Pine Script的回测逻辑：

1. **盘中触发**：使用High/Low价格而非Close价格
2. **精确出场价**：触发时使用止盈/止损价，而非当前市场价
3. **手续费模型**：双边扣除，符合真实交易场景
4. **优先级判断**：同时触发时根据K线形态判断
5. **时间框架自动检测**：支持多种数据格式

## 注意事项

1. **数据格式**：支持xts对象和data.table格式
2. **列名要求**：需要包含 `open`, `high`, `low`, `close`, `timestamp` 列
3. **时间戳**：自动处理Unix时间戳和POSIXct格式
4. **手续费**：可通过 `fee_rate` 参数调整（默认0.00075）
5. **性能**：大数据集可能需要较长运行时间

## 技术特点

- **现代化R代码**：使用data.table高性能数据处理
- **详细日志**：每笔交易都有完整的输出信息
- **统计分析**：自动计算胜率、平均盈亏、最大盈亏等指标
- **可扩展性**：易于添加新的出场条件或指标
- **类型安全**：所有数值转换都有类型检查

## 版本历史

- **v1.0**（2025-10-26）：初始版本，完全对齐Pine Script
  - 实现盘中触发逻辑
  - 添加手续费模型
  - 支持多种数据格式
  - 完整的版本对比测试

## 许可与贡献

此代码用于学习和研究目的。在真实交易中使用前，请务必进行充分的测试和验证。
