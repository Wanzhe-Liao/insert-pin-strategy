# R vs Pine Script 成本模型差异 - 快速参考指南

## 一、核心结论

### 手续费对比

| 项目 | Pine Script | R代码（pepe_fixed系列） | 是否一致 |
|------|-------------|----------------------|---------|
| 手续费率 | **0%** (默认) | **0%** | ✅ 完全一致 |
| 入场扣费 | 无 | 无 | ✅ |
| 出场扣费 | 无 | 无 | ✅ |
| 滑点 | 无 | 无 | ✅ |

**结论：手续费模型完全一致，不是导致收益差异的原因。**

---

## 二、真正的差异来源（按影响排序）

### 1. lookbackDays语义错误（影响-50%至-90%）✅ 已修复

**问题：**
- Pine: `lookbackDays=3` → 3天 = 288根15分钟K线
- R原代码: `lookbackBars=3` → 3根K线

**修复状态：** ✅ 已在 `optimize_pepe_fixed.R` 中修复

---

### 2. 入场价格差异（影响±10%至±30%）⚠️ 需统一

| NEXT_BAR_ENTRY | Pine Script | R代码 | 是否一致 |
|----------------|-------------|-------|---------|
| FALSE | Close | Close | ✅ 一致 |
| TRUE | Close | **Next Open** | ❌ 不一致 |

**当前状态：**
- `optimize_pepe_fixed.R`: `NEXT_BAR_ENTRY=FALSE` ✅ 已对齐
- `optimize_drop_strategy.R`: `NEXT_BAR_ENTRY=TRUE` ❌ 未对齐

**建议：** 统一设为 `FALSE`

---

### 3. 数据源精度（影响±1%至±3%）⚠️ 需验证

**验证方法：**
在TradingView上对比同一时间点的OHLC数据

---

## 三、代码对比速查表

### 入场逻辑

**Pine Script（推测）：**
```pine
if longSignal and strategy.position_size == 0
    strategy.entry("Long", strategy.long)  // 在Close入场
```

**R代码（NEXT_BAR_ENTRY=FALSE）：**
```r
entry_price <- as.numeric(data[i, "Close"])  # ✅ 一致
position <- capital / entry_price            # ✅ 全仓
capital <- 0                                 # ✅ 无手续费
```

**R代码（NEXT_BAR_ENTRY=TRUE）：**
```r
entry_price <- as.numeric(data[i+1, "Open"])  # ❌ 不一致
position <- capital / entry_price
capital <- 0
```

---

### 手续费扣除（如启用）

**参考实现：** `optimize_drop_strategy.R`

```r
FEE <- 0.001  # 0.1%单边手续费

# 入场
nav[entry_idx] <- nav[entry_idx] * (1 - FEE)

# 出场
nav[exit_idx] <- nav[exit_idx] * (1 - FEE)

# 双边总成本 = 0.2%
```

---

## 四、推荐配置

### 对齐Pine Script（回测验证用）

```r
NEXT_BAR_ENTRY <- FALSE  # ✅ 对齐process_orders_on_close
ENABLE_FEE <- FALSE      # ✅ 对齐默认0%手续费
ENABLE_SLIPPAGE <- FALSE # ✅ 对齐默认0滑点
```

### 实盘模拟（实际交易评估）

```r
NEXT_BAR_ENTRY <- TRUE   # 考虑执行延迟
ENABLE_FEE <- TRUE       # 启用手续费
FEE_RATE <- 0.001        # 币安现货0.1%
ENABLE_SLIPPAGE <- TRUE  # 启用滑点
SLIPPAGE_RATE <- 0.002   # 暴跌时0.2%

# 预期影响：收益率降低10%-20%
```

---

## 五、验证清单

对齐Pine Script前，请确认：

- [ ] `NEXT_BAR_ENTRY=FALSE`
- [ ] `ENABLE_FEE=FALSE`（或确认Pine中也设置了相同手续费）
- [ ] lookbackDays已正确转换为bar数
- [ ] 在TradingView上对比几个信号触发时间点
- [ ] 交易数量应完全一致
- [ ] 收益率差异<5%

---

## 六、手续费影响速查

### 单笔交易（0.1%双边手续费）

| 毛收益 | 无手续费 | 0.1%手续费 | 损失 |
|-------|---------|-----------|------|
| +20% | +20.00% | +19.76% | -0.24% |
| +10% | +10.00% | +9.78% | -0.22% |
| +5% | +5.00% | +4.80% | -0.20% |
| -10% | -10.00% | -10.18% | -0.18% |

### 累计影响（100笔交易，平均+5%/笔）

| 手续费 | 总收益 | 损失 |
|-------|-------|------|
| 0% | 13,150% | - |
| 0.1%双边 | 11,739% | -10.7% |

---

## 七、快速诊断流程

**如果R收益与Pine差异>10%：**

1. ✅ 检查lookbackDays转换（已修复）
2. ⚠️ 检查`NEXT_BAR_ENTRY`设置
3. ⚠️ 对比信号触发时间点（前10个）
4. ⚠️ 检查数据源OHLC是否一致
5. ✅ 检查手续费设置（当前均为0%）

**如果差异<5%：**
- ✅ 可能是数据精度差异（可接受）
- ✅ 可能是时间戳轻微偏差（可接受）

---

## 八、文件对应关系

| 文件 | 手续费 | NEXT_BAR_ENTRY | 对齐状态 |
|------|-------|----------------|---------|
| optimize_pepe_fixed.R | 0% | FALSE | ✅ 已对齐 |
| test_pepe_fixed.R | 0% | FALSE | ✅ 已对齐 |
| quick_test_10params.R | 0% | FALSE | ✅ 已对齐 |
| optimize_drop_strategy.R | 0.1% | TRUE | ❌ 未对齐 |

---

**报告时间：** 2025-10-26
**详细分析：** 见 `R_vs_PineScript_成本模型差异分析.md`
