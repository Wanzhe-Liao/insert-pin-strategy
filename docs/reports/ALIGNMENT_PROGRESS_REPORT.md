# R vs TradingView 对齐进度报告

## 执行日期: 2025-10-27

---

## 核心发现

### ✅ 已解决的问题

1. **移除信号滞后操作**
   - 问题: `window_high_prev <- c(NA, window_high[1:(n-1)])` 导致信号延迟1根K线(15分钟)
   - 修复: 直接使用 `window_high`,不再滞后
   - 文件: `backtest_tradingview_aligned.R` 第115-120行

2. **规范化TradingView时间戳**
   - 问题: TV数据混用K线开始时间(XX:XX:00.000)和结束时间(XX:XX:59.999)
   - 修复: 统一转换为K线结束时间格式
   - 文件: `tv_trades_fixed.csv`

3. **胜率100%对齐**
   - R回测胜率: 100% (9胜/0负) ✅
   - TradingView胜率: 100% (9胜/0负) ✅
   - 交易#9: 从止损-10%变为止盈+10% ✅

---

## 当前对齐状态

| 指标 | 对齐率 | 状态 |
|------|--------|------|
| 交易数量 | 9 vs 9 | ✅ 100% |
| 入场时间 | 7/9 | ⚠️ 77.8% |
| 出场时间 | 2/9 | ❌ 22.2% |
| 盈亏一致性 | 8/9 | ⚠️ 88.9% |
| 胜率 | 100% vs 100% | ✅ 100% |

---

## 剩余问题分析

### 问题1: 入场时间差异(2笔不匹配)

**交易#4**:
- TV: 2024-01-03 19:59
- R: 2024-01-03 20:14
- 差异: +15分钟(1根K线)

**交易#9**:
- TV: 2025-10-11 05:44
- R: 2025-10-11 06:14
- 差异: +30分钟(2根K线)

**可能原因**:
- 信号检测窗口边界差异
- 数据微小差异导致跌幅计算不同
- 需要逐K线调试这两笔交易

---

### 问题2: 出场时间差异(7笔不匹配)

大部分交易出场时间差15分钟(1根K线):

| 交易# | TV出场 | R出场 | 差异 |
|-------|--------|-------|------|
| 1 | 03:29 | 03:44 | +15分钟 |
| 2 | 06:14 | 05:59 | -15分钟 |
| 3 | 07:59 | 08:14 | +15分钟 |
| 4 | 00:29 | 00:29 | ✅ 一致 |
| 5 | 04:59 | 05:14 | +15分钟 |
| 6 | 03:29 | 03:44 | +15分钟 |
| 7 | 05:44 | 05:59 | +15分钟 |
| 8 | 05:44 | 05:44 | ✅ 一致 |
| 9 | 02:29 | 17:14 | +890分钟 |

**可能原因**:
- R的`i > entryBar`条件导致延迟1根K线检查出场
- TradingView可能在入场当根K线就检查出场

---

### 问题3: 出场价格差异(交易#8)

**时间完全一致,但盈亏差异巨大**:

```
入场: TV=05:29 @ $0.00000495 | R=05:29 @ $0.00000495 ✅
出场: TV=05:44 @ $0.00000635 | R=05:44 @ $0.00000545 ❌
盈亏: TV=28.09% | R=10.00% ❌
```

**K线(05:44)数据**:
- 高价: $0.00000675 (远超止盈价$0.00000545)
- 收盘价: $0.00000635

**分析**:
- **R逻辑**: 检测到高价触发止盈 → 使用精确止盈价$0.00000545出场 → 盈亏10%
- **TV逻辑**: 持有到收盘 → 使用收盘价$0.00000635出场 → 盈亏28.09%

**结论**:
TradingView可能**不使用精确的止盈价**,而是使用**收盘价**作为出场价!

---

## 根本原因假设

### 假设1: TradingView使用收盘价出场

Pine Script的`process_orders_on_close=true`可能意味着:
1. 在K线收盘时检查止盈止损条件
2. 如果触发,使用**收盘价**而非精确的TP/SL价格成交
3. 这与真实交易更接近(滑点)

### 假设2: 出场检查时机不同

- **TradingView**: 可能在入场K线的下一根收盘时就检查出场(使用`>=`逻辑)
- **R当前**: 使用`i > entryBar`,强制等待至少1根K线后才检查

---

## 下一步行动建议

### 优先级1: 修复出场价格逻辑(修复交易#8)

```r
# 当前实现(错误)
if (hitTP) {
  exitPrice <- tpPrice  # 使用精确止盈价
  ...
}

# 建议修改
if (hitTP) {
  exitPrice <- currentClose  # 使用收盘价
  ...
}
```

**预期效果**:
- 交易#8盈亏: 从10%变为28.09% ✅
- 其他交易盈亏: 可能从10%变为9.9%-10.3%(接近TV)

---

### 优先级2: 调整出场检查条件

尝试两种方案:

**方案A**: 改为`i >= entryBar`
```r
if (inPosition && i >= entryBar) {  # 允许同K线检查出场
```

**方案B**: 保持`i > entryBar`,但检查TV逻辑

需要确认TradingView是否真的允许同K线出场。

---

### 优先级3: 调试入场差异(交易#4和#9)

创建详细调试脚本:
1. 逐K线打印信号检测过程
2. 打印滚动窗口最高价
3. 打印跌幅计算
4. 对比TV和R的具体数值

---

## 技术债务

1. `i > entryBar` vs `i >= entryBar` - 需要明确TradingView行为
2. 精确TP/SL价格 vs 收盘价 - 需要确认TV使用哪种
3. 信号检测边界条件 - 需要更深入对齐Pine Script

---

## 总体评估

**当前完成度**: 约75%

✅ **已完成**:
- 交易数量对齐(9笔)
- 胜率对齐(100%)
- 大部分入场时间对齐(77.8%)
- 信号滞后问题解决

⚠️ **进行中**:
- 出场时间对齐(22.2%)
- 出场价格逻辑

❌ **待解决**:
- 交易#4和#9的入场时间差异
- 交易#8的盈亏差异
- 所有交易的出场时间15分钟偏移

---

**生成时间**: 2025-10-27
**状态**: 需要修复出场价格逻辑 + 调试入场差异
