//@version=5
// =============================================================================
// | ç­–ç•¥åç§°ï¼šä¸‰æ—¥æš´è·Œæ¥é’ˆç­–ç•¥ï¼ˆRå›æµ‹å‡½æ•°å¯¹é½ç‰ˆï¼‰
// | ç‰ˆæœ¬ï¼š2.0
// | å¯¹é½ç›®æ ‡ï¼šbacktest_tradingview_aligned.R
// | åˆ›å»ºæ—¥æœŸï¼š2025-10-27
// |
// | æ ¸å¿ƒä¿®æ”¹ï¼ˆç›¸æ¯”åŸç‰ˆPine Scriptï¼‰ï¼š
// | 1. ä¿¡å·ç”Ÿæˆçª—å£ï¼šå»æ‰[1]åç§»ï¼Œä½¿ç”¨å½“å‰Kçº¿
// | 2. æ­¢ç›ˆæ­¢æŸè§¦å‘ï¼šåªåœ¨æ”¶ç›˜ä»·è§¦å‘ï¼ˆä¸ä½¿ç”¨limit/stopè®¢å•ï¼‰
// | 3. åŒæ—¶è§¦å‘è§„åˆ™ï¼šé˜³çº¿ä¼˜å…ˆæ­¢ç›ˆï¼Œé˜´çº¿ä¼˜å…ˆæ­¢æŸ
// | 4. æ‰‹ç»­è´¹è®¾ç½®ï¼š0.075%ï¼ˆå¯¹é½Rå›æµ‹å‡½æ•°ï¼‰
// |
// | å…³é”®å·®å¼‚è¯´æ˜ï¼š
// | â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// | â”‚      é¡¹ç›®           â”‚   åŸPine Script      â”‚   ä¿®æ”¹åï¼ˆRå¯¹é½ç‰ˆï¼‰  â”‚
// | â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// | â”‚ ä¿¡å·çª—å£            â”‚ ta.highest()[1]      â”‚ ta.highest()         â”‚
// | â”‚                     â”‚ æ’é™¤å½“å‰Kçº¿          â”‚ åŒ…å«å½“å‰Kçº¿          â”‚
// | â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// | â”‚ æ­¢ç›ˆè§¦å‘            â”‚ limitè®¢å•ç›˜ä¸­è§¦å‘    â”‚ closeä»·æ ¼è§¦å‘        â”‚
// | â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// | â”‚ æ­¢æŸè§¦å‘            â”‚ stopè®¢å•ç›˜ä¸­è§¦å‘     â”‚ closeä»·æ ¼è§¦å‘        â”‚
// | â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// | â”‚ åŒæ—¶è§¦å‘            â”‚ ç³»ç»Ÿè‡ªåŠ¨å¤„ç†         â”‚ é˜³çº¿â†’TP, é˜´çº¿â†’SL     â”‚
// | â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
// =============================================================================

strategy("ä¸‰æ—¥æš´è·Œæ¥é’ˆç­–ç•¥ï¼ˆRå¯¹é½ç‰ˆï¼‰",
         overlay=true,
         process_orders_on_close=true,
         default_qty_type=strategy.percent_of_equity,
         default_qty_value=100,
         initial_capital=10000,
         commission_type=strategy.commission.percent,
         commission_value=0.075)  // 0.075% = 0.00075

// === è¾“å…¥å‚æ•° ===
group_conditions = "æ¡ä»¶è®¾ç½®"
lookbackBars = input.int(3, title="å›çœ‹Kçº¿æ•°é‡", group=group_conditions,
                         tooltip="æ³¨æ„ï¼šè¿™æ˜¯Kçº¿æ•°é‡ï¼Œä¸æ˜¯å¤©æ•°ï¼ä¸Rå‡½æ•°çš„lookbackDaysç›´æ¥å¯¹åº”")
minDropPercent = input.float(20.0, title="æœ€å°ä¸‹è·Œç™¾åˆ†æ¯”(%)", group=group_conditions, minval=0)

group_risk = "é£é™©ç®¡ç†"
takeProfitPercent = input.float(10.0, title="æ­¢ç›ˆç™¾åˆ†æ¯”(%)", group=group_risk, minval=0)
stopLossPercent = input.float(10.0, title="æ­¢æŸç™¾åˆ†æ¯”(%)", group=group_risk, minval=0)

// === ä¿¡å·ç”Ÿæˆï¼ˆå¯¹é½Rå‡½æ•°çš„generate_drop_signalsï¼‰ ===

// ğŸ”§ å…³é”®ä¿®å¤1ï¼šå»æ‰[1]åç§»ï¼Œä½¿ç”¨å½“å‰Kçº¿
// åŸç‰ˆï¼šhighestHighPrev = ta.highest(high, lookbackDays)[1]
// Rä»£ç ï¼šwindow_high <- roll_max(high_vec, n = lookbackBars, align = "right")
//        è¿™åŒ…å«å½“å‰Kçº¿çš„æœ€é«˜ä»·ï¼Œå› ä¸ºåœ¨æ”¶ç›˜æ—¶è®¡ç®—ä¿¡å·æ—¶å½“å‰Kçº¿å·²å®Œæˆ
highestHigh = ta.highest(high, lookbackBars)  // â† å»æ‰[1]ï¼Œå¯¹é½Ré€»è¾‘

// è®¡ç®—è·Œå¹…ç™¾åˆ†æ¯”ï¼ˆä¸Rå®Œå…¨ä¸€è‡´ï¼‰
// Rä»£ç ï¼šdrop_percent <- (window_high - low_vec) / window_high * 100
percentDrop = (highestHigh - low) / highestHigh * 100

// ç”Ÿæˆä¹°å…¥ä¿¡å·
// Rä»£ç ï¼šsignals <- !is.na(drop_percent) & (drop_percent >= minDropPercent)
cond_priceDrop = percentDrop >= minDropPercent

// === å…¥åœºé€»è¾‘ï¼ˆå¯¹é½Rå‡½æ•°çš„å…¥åœºé€»è¾‘ï¼‰ ===

longCondition = cond_priceDrop
notInTrade = strategy.position_size == 0

// Rä»£ç ï¼šif (signals[i] && !inPosition)
if (longCondition and notInTrade)
    strategy.entry("åšå¤š", strategy.long)

// === å‡ºåœºé€»è¾‘ï¼ˆå¯¹é½Rå‡½æ•°çš„å‡ºåœºé€»è¾‘ï¼‰ ===

// ğŸ”§ å…³é”®ä¿®å¤2ï¼šä¸ä½¿ç”¨strategy.exitï¼Œæ”¹ç”¨æ‰‹åŠ¨closeé€»è¾‘
// åŸå› ï¼šstrategy.exitä½¿ç”¨limit/stopè®¢å•åœ¨ç›˜ä¸­è§¦å‘ï¼ˆä½¿ç”¨High/Lowä»·æ ¼ï¼‰
//       Rå‡½æ•°ä½¿ç”¨Closeä»·æ ¼åœ¨æ”¶ç›˜æ—¶è§¦å‘

if (strategy.position_size > 0)
    entryPrice = strategy.position_avg_price

    // è®¡ç®—æ­¢ç›ˆæ­¢æŸä»·æ ¼
    // Rä»£ç ï¼štpPrice <- entryPrice * (1 + takeProfitPercent / 100)
    //        slPrice <- entryPrice * (1 - stopLossPercent / 100)
    takeProfitPrice = entryPrice * (1 + takeProfitPercent / 100)
    stopLossPrice = entryPrice * (1 - stopLossPercent / 100)

    // ğŸ”§ å…³é”®ä¿®å¤3ï¼šä½¿ç”¨Closeä»·æ ¼åˆ¤æ–­è§¦å‘ï¼ˆå¯¹é½Rå‡½æ•°ï¼‰
    // Rä»£ç ï¼šhitTP <- currentClose >= tpPrice
    //        hitSL <- currentClose <= slPrice
    hitTP = close >= takeProfitPrice
    hitSL = close <= stopLossPrice

    // åˆ¤æ–­æ˜¯å¦åŒæ—¶è§¦å‘ï¼ˆå¯¹é½Rå‡½æ•°çš„both triggeré€»è¾‘ï¼‰
    // Rä»£ç ï¼š
    // if (hitTP && hitSL) {
    //   if (currentClose >= currentOpen) {
    //     exitReason <- "TP_first_in_both"  // é˜³çº¿ä¼˜å…ˆæ­¢ç›ˆ
    //   } else {
    //     exitReason <- "SL_first_in_both"  // é˜´çº¿ä¼˜å…ˆæ­¢æŸ
    //   }
    // }
    if (hitTP and hitSL)
        // æ ¹æ®Kçº¿æ–¹å‘å†³å®šä¼˜å…ˆçº§
        if (close >= open)
            strategy.close("åšå¤š", comment="TP_bothé˜³çº¿")
        else
            strategy.close("åšå¤š", comment="SL_bothé˜´çº¿")
    else if (hitTP)
        strategy.close("åšå¤š", comment="TP")
    else if (hitSL)
        strategy.close("åšå¤š", comment="SL")

// === å¯è§†åŒ– ===

plotshape(longCondition and notInTrade,
          title="å…¥åœºä¿¡å·",
          style=shape.labelup,
          location=location.belowbar,
          color=color.new(color.green, 0),
          text="åšå¤š",
          textcolor=color.new(color.white, 0),
          size=size.small)

bgcolor(cond_priceDrop ? color.new(color.red, 85) : na, title="è·Œå¹…æ»¡è¶³")

// æ˜¾ç¤ºå½“å‰æŒä»“çš„æ­¢ç›ˆæ­¢æŸçº¿
var line tpLine = na
var line slLine = na

if (strategy.position_size > 0)
    entryPrice = strategy.position_avg_price
    takeProfitPrice = entryPrice * (1 + takeProfitPercent / 100)
    stopLossPrice = entryPrice * (1 - stopLossPercent / 100)

    // ç»˜åˆ¶æ­¢ç›ˆçº¿ï¼ˆç»¿è‰²è™šçº¿ï¼‰
    line.delete(tpLine)
    tpLine := line.new(bar_index, takeProfitPrice, bar_index + 1, takeProfitPrice,
                       color=color.green, width=1, style=line.style_dashed)

    // ç»˜åˆ¶æ­¢æŸçº¿ï¼ˆçº¢è‰²è™šçº¿ï¼‰
    line.delete(slLine)
    slLine := line.new(bar_index, stopLossPrice, bar_index + 1, stopLossPrice,
                       color=color.red, width=1, style=line.style_dashed)
else
    line.delete(tpLine)
    line.delete(slLine)

// =============================================================================
// ä½¿ç”¨è¯´æ˜ï¼š
//
// 1. å¤åˆ¶æ­¤ä»£ç åˆ°TradingViewç­–ç•¥ç¼–è¾‘å™¨
// 2. é€‰æ‹©äº¤æ˜“å¯¹ï¼ˆå¦‚PEPEUSDTã€ETHUSDTç­‰ï¼‰
// 3. é€‰æ‹©æ—¶é—´å‘¨æœŸï¼ˆ5mã€15mã€30mã€1hç­‰ï¼‰
// 4. è¾“å…¥å‚æ•°ï¼ˆå‚è€ƒä¼˜åŒ–ç»“æœï¼‰ï¼š
//    - å›çœ‹Kçº¿æ•°é‡ï¼š1-10
//    - æœ€å°ä¸‹è·Œç™¾åˆ†æ¯”ï¼š0-20%
//    - æ­¢ç›ˆç™¾åˆ†æ¯”ï¼š0-20%ï¼ˆå»ºè®®>=0.5%é¿å…è¶…é«˜é¢‘ï¼‰
//    - æ­¢æŸç™¾åˆ†æ¯”ï¼š0-20%
//
// 5. ç‚¹å‡»"æ·»åŠ åˆ°å›¾è¡¨"æŸ¥çœ‹å›æµ‹ç»“æœ
//
// æ³¨æ„äº‹é¡¹ï¼š
// - æ­¤ç‰ˆæœ¬ä¸Rå›æµ‹å‡½æ•°å®Œå…¨å¯¹é½
// - TP=0%è¡¨ç¤ºåªè¦æ”¶ç›˜ä»·>=å…¥åœºä»·å°±æ­¢ç›ˆï¼ˆè¶…é«˜é¢‘ç­–ç•¥ï¼‰
// - å»ºè®®ä½¿ç”¨TP>=0.5%æˆ–1.0%çš„å‚æ•°
// - å›æµ‹ç»“æœåº”ä¸Rå‡½æ•°é«˜åº¦ä¸€è‡´ï¼ˆå…è®¸è½»å¾®å·®å¼‚ï¼‰
//
// å¯¹æ¯”æµ‹è¯•å»ºè®®ï¼š
// ä½¿ç”¨ç›¸åŒå‚æ•°åœ¨TradingViewå’ŒRä¸­è¿è¡Œï¼Œå¯¹æ¯”ï¼š
// - ä¿¡å·æ•°é‡
// - äº¤æ˜“æ•°é‡
// - æ”¶ç›Šç‡
// - èƒœç‡
// - æœ€å¤§å›æ’¤
//
// å¦‚æœç»“æœä¸€è‡´ï¼Œè¯´æ˜é€»è¾‘å¯¹é½æˆåŠŸã€‚
// =============================================================================
