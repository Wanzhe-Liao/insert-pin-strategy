# 三日暴跌接针策略 - 回测汇总文档

**整理日期**: 2025-10-27
**版本**: v2 (交易数量权重0.30, 步长0.05%)

---

## 📁 文件夹结构

```
策略回测汇总_2025-10-27/
├── README.md                          ← 本文件（使用说明）
├── 1_回测引擎/
│   └── backtest_tradingview_aligned.R ← TradingView对齐版R回测引擎
├── 2_优化脚本/
│   ├── test_all_timeframes.R          ← 全时间周期优化脚本（28个数据集）
│   └── parallel_smart_search.R        ← 单币种并行优化脚本
├── 3_优化结果/
│   ├── v1_step01_best_params.csv      ← V1版本最佳参数（步长0.1%）
│   ├── v1_step01_报告.md               ← V1版本优化总结报告
│   └── (v2版本结果运行中，完成后会添加...)
└── 4_TradingView代码/
    └── 三日暴跌接针策略_R对齐版.txt    ← 对齐R回测引擎的Pine Script代码
```

---

## 📊 版本对比

### V1版本（2025-10-27 初版）
- **目标函数权重**: 0.45×收益率 + 0.30×回撤 + 0.15×胜率 + 0.10×交易数量
- **参数步长**: 0.1%
- **参数空间**: 81,362,010 种组合
- **TOP 3结果**:
  1. ETHUSDT_30m: 评分0.9036, 收益2992%, TP=0.0%
  2. SOLUSDT_5m: 评分0.9007, 收益2768%, TP=0.3%
  3. BNBUSDT_15m: 评分0.8999, 收益8795%, TP=0.4%
- **关键发现**: 极低止盈（TP=0-1.4%）占主导地位

### V2版本（2025-10-27 改进版）- 运行中
- **目标函数权重**: 0.35×收益率 + 0.30×回撤 + 0.05×胜率 + **0.30×交易数量** ⬆️
- **参数步长**: 0.05% ⬆️
- **参数空间**: 645,210,010 种组合（增长8倍）
- **改进点**:
  - 交易数量权重从0.10提升到0.30（强调高频策略）
  - 参数精度提高到0.05%（可能找到更优配置）
  - 收益率权重适度降低（避免过度追求极端收益）
- **状态**: 🔄 正在运行（预计100-120分钟）

---

## 🚀 快速开始

### 1. 查看回测引擎

```r
# 打开R或RStudio
source("1_回测引擎/backtest_tradingview_aligned.R")

# 加载数据
load('data/liaochu.RData')
data <- cryptodata[["ETHUSDT_30m"]]

# 运行回测（使用V1最佳参数）
result <- backtest_tradingview_aligned(
  data = data,
  lookbackDays = 2,
  minDropPercent = 6.2,
  takeProfitPercent = 0.0,
  stopLossPercent = 7.4,
  initialCapital = 10000,
  feeRate = 0.00075,
  processOnClose = TRUE,
  verbose = TRUE
)

# 查看结果
print_performance_summary(result)
```

### 2. 运行优化

```r
# 全时间周期优化（28个数据集）
source("2_优化脚本/test_all_timeframes.R")

# 或单币种优化（PEPEUSDT 15m）
source("2_优化脚本/parallel_smart_search.R")
```

### 3. 在TradingView中测试

1. 打开 `4_TradingView代码/三日暴跌接针策略_R对齐版.txt`
2. 复制全部代码
3. 在TradingView中创建新的Pine Script策略
4. 粘贴代码并保存
5. 使用V1最佳参数测试：
   - ETHUSDT 30分钟
   - 回看K线=2, 跌幅=6.2%, TP=0%, SL=7.4%

---

## 📈 V1优化结果亮点

### 按交易对分组的最佳配置

| 币种 | 最佳周期 | 参数 | 收益% | 胜率% | 回撤% | 评分 |
|------|---------|------|-------|-------|-------|------|
| **ETH** | 30m | lookback=2, drop=6.2%, TP=0%, SL=7.4% | 2992 | 91.0 | -27.6 | 0.9036 |
| **SOL** | 5m | lookback=10, drop=8.7%, TP=0.3%, SL=14.4% | 2768 | 96.9 | -28.2 | 0.9007 |
| **BNB** | 15m | lookback=10, drop=10.7%, TP=0.4%, SL=12.7% | 8795 | 95.8 | -28.4 | 0.8999 |
| **BTC** | 30m | lookback=10, drop=10.5%, TP=1.2%, SL=18.8% | 2762 | 99.2 | -21.1 | 0.8923 |
| **DOGE** | 15m | lookback=10, drop=9.5%, TP=0.3%, SL=18.3% | 2475 | 92.7 | -55.7 | 0.8174 |
| **PEPE** | 15m | lookback=8, drop=7.0%, TP=1.4%, SL=12.8% | 2594 | 90.0 | -46.6 | 0.8452 |

### 关键洞察

1. **极低止盈策略**：TOP 10中70%使用TP≤1%
2. **主流币优势**：BTC/ETH/BNB/SOL表现稳定，评分>0.88
3. **30分钟周期最优**：综合评分最高的时间周期
4. **高胜率可实现**：主流币在各周期均能实现95%+胜率
5. **回撤可控**：最优配置回撤在20-30%范围

---

## 🔬 回测引擎核心特性

### 与TradingView完全对齐

`backtest_tradingview_aligned.R` 实现了以下关键修复：

1. **信号生成窗口**：包含当前K线（去掉[1]偏移）
2. **止盈止损触发**：默认使用 Close 触发 + Close 成交价（`exitMode="close"`），也可切换为 High/Low 盘中触发 + 精确 TP/SL 成交价（`exitMode="tradingview"`）
3. **同时触发规则**：阳线优先止盈，阴线优先止损
4. **严格持仓管理**：一次只一个持仓
5. **手续费设置**：0.075%（对齐Binance）

### Pine Script对齐验证

- `exitMode="close"`：使用 `4_TradingView代码/三日暴跌接针策略_R对齐版.txt`（手动 close：Close 触发 + Close 成交价）
- `exitMode="tradingview"`：使用 `4_TradingView代码/三日暴跌接针策略_TV对齐版.txt`（strategy.exit：High/Low 盘中触发 + 精确 TP/SL 成交价）

---

## ⚙️ 优化方法

### 目标函数（V2版本）

```r
Score = 0.35×(收益率归一化) +
        0.30×(回撤控制归一化) +
        0.05×(胜率归一化) +
        0.30×(交易数量归一化)
```

### 智能采样策略

- **阶段1** (5000次): 全空间随机采样
- **阶段2** (10000次): Top 20%区域聚焦
- **阶段3** (5000次): Top 10%精英细化
- **并行化**: 32核真并行，速度~289次/秒

### 参数范围

- **lookbackDays**: 1-10（K线数量，不是天数）
- **minDropPercent**: 0-20%（步长0.05%）
- **takeProfitPercent**: 0-20%（步长0.05%）
- **stopLossPercent**: 0-20%（步长0.05%）

---

## ⚠️ 风险提示

1. **过拟合风险**: 所有参数基于历史数据优化
2. **市场环境依赖**: 策略在趋势性暴跌后表现最佳
3. **黑天鹅事件**: 极端行情可能突破历史回撤
4. **仓位管理**: 建议使用账户资金的10-20%
5. **分散配置**: 选择2-3个不同币种和时间周期

---

## 📚 相关文件说明

### 回测引擎文件

- **backtest_tradingview_aligned.R**:
  - 主回测函数（681行）
  - 对齐TradingView的精确实现
  - 包含信号生成、持仓管理、出场逻辑
  - 详细的交易日志和性能指标

### 优化脚本文件

- **test_all_timeframes.R**:
  - 全时间周期优化（345行）
  - 处理28个数据集（7个币种×4个时间周期）
  - 32核并行优化
  - 输出CSV和控制台报告

- **parallel_smart_search.R**:
  - 单币种优化（300行）
  - 三阶段智能采样
  - 实时进度显示
  - 保存TOP 20结果

### 结果文件

- **v1_step01_best_params.csv**:
  - 28行数据（每个数据集的最佳参数）
  - 列: dataset, lookback, minDrop, TP, SL, score, return_pct, win_rate, max_dd, trades

- **v1_step01_报告.md**:
  - 完整的优化分析报告（494行）
  - 包含TOP 10配置、关键洞察、实战建议
  - 按交易对分组的详细分析

### TradingView代码

- **三日暴跌接针策略_R对齐版.txt**:
  - 完整的Pine Script v5代码
  - 与R回测引擎逻辑完全对齐
  - 包含详细的修改说明和使用指南

---

## 🔄 更新日志

### 2025-10-27
- ✅ 创建汇总文件夹
- ✅ 整理V1版本代码和结果
- ✅ 创建对齐的Pine Script代码
- 🔄 运行V2版本优化（交易数量权重0.30）

---

## 📧 问题反馈

如有任何问题或建议，请检查：
1. R回测引擎是否正确加载数据
2. 参数是否在有效范围内
3. TradingView代码是否完整复制
4. 手续费设置是否一致（0.075%）

---

**生成时间**: 2025-10-27
**生成工具**: Claude Code AI
**版本**: v2.0
